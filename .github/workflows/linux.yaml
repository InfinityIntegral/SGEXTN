name: Linux build and test

on:
  workflow_dispatch:

env:
  APPNAME: sg-extn
  VERSION: 6.1.0
  QTVERSION: 6.10.1
  CMAKETARGET: InternalTest
  TESTARG: --SG-test
  PLATFORM: linux-gcc

jobs:
  build:
    name: build app
    runs-on: ubuntu-22.04

    steps:
      - name: pull repository
        uses: actions/checkout@v3

      - name: install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{env.QTVERSION}}
          host: linux
          target: desktop
          dir: ${{github.workspace}}/..
          cache: true
          modules: qtshadertools
          tools: 'tools_cmake tools_ninja'

      - name: install devtools
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential
          sudo apt-get install -y git

      - name: delete unnecessary Qt plugins
        run: |
          rm -rf ../Qt/${{env.QTVERSION}}/gcc_64/plugins/designer
          rm -rf ../Qt/${{env.QTVERSION}}/gcc_64/plugins/help
          rm -rf ../Qt/${{env.QTVERSION}}/gcc_64/plugins/printsupport
          rm -rf ../Qt/${{env.QTVERSION}}/gcc_64/plugins/sqldrivers

      - name: build linuxdeployqt
        run: |
          cd ..
          git clone https://github.com/probonopd/linuxdeployqt.git
          cd linuxdeployqt
          mkdir build
          cd build
          cmake .. -G "Ninja" -DCMAKE_PREFIX_PATH=../../Qt/${{env.QTVERSION}}/gcc_64
          cmake --build .
          cp ../../Qt/${{env.QTVERSION}}/gcc_64/libexec/qmlimportscanner tools/linuxdeployqt/qmlimportscanner
          chmod +x tools/linuxdeployqt/qmlimportscanner

      - name: build application binary
        run: |
          mkdir -p build
          cd build
          cmake .. -G "Ninja" -DCMAKE_PREFIX_PATH=../../Qt/${{env.QTVERSION}}/gcc_64
          cmake --build .

      - name: delete QML tooling
        run: |
          rm -rf ../Qt/${{env.QTVERSION}}/gcc_64/plugins/qmllint
          rm -rf ../Qt/${{env.QTVERSION}}/gcc_64/plugins/qmlls
          rm -rf ../Qt/${{env.QTVERSION}}/gcc_64/plugins/qmltooling

      - name: package app
        run: |
          mkdir -p package/${{env.APPNAME}}.AppDir/usr/bin
          cp $(find build -type f -executable -name "${{env.CMAKETARGET}}") package/${{env.APPNAME}}.AppDir/usr/bin/${{env.APPNAME}}
          mkdir -p package/${{env.APPNAME}}.AppDir/usr/lib
          find build -type f -name "*.so*" -exec cp {} package/${{env.APPNAME}}.AppDir/usr/lib/ \; -exec echo "Copied {} to usr/lib" \;
          ../linuxdeployqt/build/tools/linuxdeployqt/linuxdeployqt package/${{env.APPNAME}}.AppDir/usr/bin/${{env.APPNAME}} -qmldir=${{github.workspace}}/../SGEXTN/SG_Widgets/assets
          rm -rf package/${{env.APPNAME}}.AppDir/usr/plugins
          mkdir -p package/${{env.APPNAME}}.AppDir/usr/plugins
          cd ${{github.workspace}}/../Qt/${{env.QTVERSION}}/gcc_64/plugins
          find . -type f -name "*.so*" -exec cp --parents {} "${{github.workspace}}/package/${{env.APPNAME}}.AppDir/usr/plugins" \;
          cd ${{github.workspace}}
          mv package/${{env.APPNAME}}.AppDir/usr ${{env.APPNAME}}
          rm -rf ${{env.APPNAME}}/translations
          chmod +x ${{env.APPNAME}}/bin/${{env.APPNAME}}

      - name: write version file
        run: |
          echo "using Qt version ${{env.QTVERSION}}" > build/version.txt
          echo "using compiler version $(g++ --version | head -n 1)" >> build/version.txt
          echo "building application ${{env.APPNAME}} version ${{env.VERSION}}" >> build/version.txt
          cp build/version.txt ${{env.APPNAME}}/version.txt

      - name: upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{env.PLATFORM}}-${{env.APPNAME}}-${{env.VERSION}}-build
          path: build

      - name: delete everything to ensure app can run on machine of non programmer user
        run: |
          cd ..
          mv ${{github.workspace}}/${{env.APPNAME}} ${{env.APPNAME}}
          rm -rf SGEXTN
          rm -rf ${{github.workspace}}
          rm -rf Qt
          rm -rf linuxdeployqt
          sudo apt-get remove --purge -y build-essential
          sudo apt-get remove --purge -y g++
          sudo apt-get remove --purge -y gcc
          sudo apt-get remove --purge -y git
          sudo apt-get remove --purge -y qt*
          sudo apt-get autoremove -y
          sudo apt-get install -y libstdc++6
          mkdir -p ${{github.workspace}}
          mv ${{env.APPNAME}} ${{github.workspace}}/${{env.APPNAME}}

      - name: test run app
        run: |
          sudo apt-get install -y xvfb
          export PATH=/usr/bin:/bin:/usr/sbin:/sbin
          xvfb-run ./${{env.APPNAME}}/bin/${{env.APPNAME}} ${{env.TESTARG}} --SG-log-file=${{github.workspace}}/logs.txt
          EXIT_CODE=$?
          echo "Exit code: $EXIT_CODE" >> logs.txt
          exit $EXIT_CODE

      - name: print logs
        if: always()
        run: |
          cat logs.txt

      - name: upload binary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{env.PLATFORM}}-${{env.APPNAME}}-${{env.VERSION}}-binary
          path: ${{env.APPNAME}}

      - name: upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{env.PLATFORM}}-${{env.APPNAME}}-${{env.VERSION}}-logs
          path: logs.txt
